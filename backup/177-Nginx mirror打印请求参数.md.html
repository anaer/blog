
  <article class="markdown-body">
    <p>Python 3.6.8  </p>
<h2 id="apppy">app.py</h2>
<div class="highlight"><div class="code-block-wrapper"><div class="code-block-controls"><button class="fold-btn">▲</button><button class="copy-btn"><svg width="18" height="18" viewBox="0 0 20 20" style="vertical-align:middle"><rect x="6" y="2" width="9" height="13" rx="2" fill="#555"/><rect x="3" y="5" width="9" height="13" rx="2" fill="#aaa"/></svg></button></div>
<pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>  
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>  

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>  
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>  
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(levelname)s</span><span class="s2"> </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>  
    <span class="n">handlers</span><span class="o">=</span><span class="p">[</span>  
        <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(),</span>  
        <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s2">&quot;app.log&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>  
    <span class="p">]</span>  
<span class="p">)</span>  

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&lt;path:path&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>  
<span class="k">def</span><span class="w"> </span><span class="nf">handle_request</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>  
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>  

    <span class="k">try</span><span class="p">:</span>  
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>  

        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Forwarded-Proto&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Host&#39;</span><span class="p">]</span><span class="si">}{</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Mirror-Path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>  

        <span class="n">exclude_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Accept-Encoding&quot;</span><span class="p">,</span> <span class="s2">&quot;Host&quot;</span><span class="p">,</span> <span class="s2">&quot;Accept&quot;</span><span class="p">,</span> <span class="s2">&quot;X-Mirror-Path&quot;</span><span class="p">,</span> <span class="s2">&quot;Connection&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="s2">&quot;X-Forwarded-Proto&quot;</span><span class="p">}</span>  
        <span class="n">filtered_headers</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_headers</span><span class="p">}</span>  
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">filtered_headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>  

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>  
            <span class="n">args_str</span> <span class="o">=</span> <span class="s2">&quot;&amp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>  
            <span class="n">msg</span> <span class="o">+=</span> <span class="n">args_str</span>  

        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>  

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>  
            <span class="n">form_str</span> <span class="o">=</span> <span class="s2">&quot;&amp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>  
            <span class="n">msg</span> <span class="o">+=</span> <span class="n">form_str</span>  

        <span class="c1">#if request.is_json:  </span>
        <span class="c1">#    msg += str(request.get_json())  </span>
        <span class="c1">#else:  </span>
        <span class="c1">#    msg += request.data.decode(&#39;utf-8&#39;)  </span>

        <span class="c1"># 尝试解析 JSON，force=True 表示忽略 Content-Type 也尝试解析  </span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  
            <span class="n">msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  
        <span class="k">else</span><span class="p">:</span>  
            <span class="n">msg</span> <span class="o">+=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">as_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>  
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>  
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  

    <span class="k">return</span> <span class="s2">&quot;Request received and logged&quot;</span>  

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>  
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">9876</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</code></pre></div></div>
<h2 id="pm2json">pm2.json</h2>
<div class="highlight"><div class="code-block-wrapper"><div class="code-block-controls"><button class="fold-btn">▲</button><button class="copy-btn"><svg width="18" height="18" viewBox="0 0 20 20" style="vertical-align:middle"><rect x="6" y="2" width="9" height="13" rx="2" fill="#555"/><rect x="3" y="5" width="9" height="13" rx="2" fill="#aaa"/></svg></button></div>
<pre><span></span><code><span class="p">{</span><span class="w">  </span>
<span class="w">  </span><span class="nt">&quot;apps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">  </span>
<span class="w">    </span><span class="p">{</span><span class="w">  </span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;mirrorlog&quot;</span><span class="p">,</span><span class="w">  </span>
<span class="w">      </span><span class="nt">&quot;script&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;python3 app.py&quot;</span><span class="p">,</span><span class="w">  </span>
<span class="w">      </span><span class="nt">&quot;instances&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span>
<span class="w">      </span><span class="nt">&quot;autorestart&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">  </span>
<span class="w">      </span><span class="nt">&quot;watch&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;app.py&quot;</span><span class="p">],</span><span class="w">  </span>
<span class="w">      </span><span class="nt">&quot;log_date_format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;YYYY-MM-DD HH:mm Z&quot;</span><span class="p">,</span><span class="w">  </span>
<span class="w">      </span><span class="nt">&quot;merge_logs&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">  </span>
<span class="w">      </span><span class="nt">&quot;error_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pm2.log&quot;</span><span class="p">,</span><span class="w">  </span>
<span class="w">      </span><span class="nt">&quot;out_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pm2.log&quot;</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span><span class="p">]</span><span class="w">  </span>
<span class="p">}</span><span class="w">  </span>
</code></pre></div></div>
<div class="highlight"><div class="code-block-wrapper"><div class="code-block-controls"><button class="fold-btn">▲</button><button class="copy-btn"><svg width="18" height="18" viewBox="0 0 20 20" style="vertical-align:middle"><rect x="6" y="2" width="9" height="13" rx="2" fill="#555"/><rect x="3" y="5" width="9" height="13" rx="2" fill="#aaa"/></svg></button></div>
<pre><span></span><code>pm2<span class="w"> </span>start<span class="w"> </span>pm2.json<span class="w">  </span>
</code></pre></div></div>
<h2 id="nginx">nginx</h2>
<div class="highlight"><div class="code-block-wrapper"><div class="code-block-controls"><button class="fold-btn">▲</button><button class="copy-btn"><svg width="18" height="18" viewBox="0 0 20 20" style="vertical-align:middle"><rect x="6" y="2" width="9" height="13" rx="2" fill="#555"/><rect x="3" y="5" width="9" height="13" rx="2" fill="#aaa"/></svg></button></div>
<pre><span></span><code>location / {  
    proxy_pass http://backend;  

    mirror /mirrorlog;  
    mirror_request_body on;  
}  

 # 定义镜像请求的处理路径  
location = /mirrorlog {  
    internal;  # 确保这个 location 只作为内部请求处理  
    proxy_pass http://127.0.0.1:9876;  # 代理请求到镜像后端  

    # 确保传递所有请求头  
    proxy_set_header Host $host;  # 保留原始请求中的 Host 头  
    proxy_set_header X-Real-IP $remote_addr;  # 保留客户端 IP  
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # 保留原始的 X-Forwarded-For 头  
    proxy_set_header X-Forwarded-Proto $scheme;  # 保留请求协议（http 或 https）  
    proxy_set_header User-Agent $http_user_agent;  # 保留请求的 User-Agent 头  
    proxy_set_header Accept $http_accept;  # 保留请求的 Accept 头  
    proxy_set_header Content-Type $http_content_type;  # 保留请求的 Content-Type 头  

    proxy_set_header X-Mirror-Path $request_uri;  # 保留原始路径（包括查询参数）  
}  
</code></pre></div></div>
  </article>
  
<style>
.code-block-wrapper {
  position: relative;
  display: inline-block;
  width: 100%;
}
.code-block-controls {
  position: absolute;
  top: 6px;
  right: 8px;
  z-index: 2;
  display: flex;
  gap: 2px;
}
.fold-btn, .copy-btn {
  border: none;
  background: transparent;
  cursor: pointer;
  padding: 2px 6px;
  font-size: 16px;
  outline: none;
  box-shadow: none;
  transition: background 0.2s;
}
.fold-btn:hover, .copy-btn:hover {
  background: #eee;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // 复制功能
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const code = btn.parentElement.parentElement.querySelector('pre code').innerText;
      navigator.clipboard.writeText(code).then(() => {
        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 20 20" style="vertical-align:middle"><path fill="green" d="M7.629 15.314l-4.243-4.243 1.414-1.414 2.829 2.828 6.364-6.364 1.414 1.414z"/></svg>';
        setTimeout(() => {
          btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 20 20" style="vertical-align:middle"><rect x="6" y="2" width="9" height="13" rx="2" fill="#555"/><rect x="3" y="5" width="9" height="13" rx="2" fill="#aaa"/></svg>';
        }, 1500);
      });
    });
  });

  // 折叠功能
  document.addEventListener('click', e => {
    if (e.target.classList.contains('fold-btn')) {
      const code = e.target.parentElement.parentElement.querySelector('pre code');
      const collapsed = code.style.display === 'none';
      code.style.display = collapsed ? 'block' : 'none';
      e.target.textContent = collapsed ? '▲' : '▼';
    }
  });
});
</script>

