<div class="markdown-heading"><h2 class="heading-element">æ£€æµ‹å¹¶å–æ¶ˆè®¾ç½® Git ä»“åº“ç”¨æˆ·ä¿¡æ¯</h2><a id="user-content-æ£€æµ‹å¹¶å–æ¶ˆè®¾ç½®-git-ä»“åº“ç”¨æˆ·ä¿¡æ¯" class="anchor" aria-label="Permalink: æ£€æµ‹å¹¶å–æ¶ˆè®¾ç½® Git ä»“åº“ç”¨æˆ·ä¿¡æ¯" href="#æ£€æµ‹å¹¶å–æ¶ˆè®¾ç½®-git-ä»“åº“ç”¨æˆ·ä¿¡æ¯"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> <span class="pl-s1">os</span>
<span class="pl-k">import</span> <span class="pl-s1">argparse</span>
<span class="pl-k">import</span> <span class="pl-s1">subprocess</span>
<span class="pl-k">import</span> <span class="pl-s1">sys</span>

<span class="pl-k">def</span> <span class="pl-en">find_git_repos</span>(<span class="pl-s1">root_dir</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    é€’å½’æŸ¥æ‰¾æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰ Git ä»“åº“</span>
<span class="pl-s">    """</span>
    <span class="pl-s1">git_repos</span> <span class="pl-c1">=</span> []
    <span class="pl-k">for</span> <span class="pl-s1">dirpath</span>, <span class="pl-s1">dirnames</span>, <span class="pl-s1">filenames</span> <span class="pl-c1">in</span> <span class="pl-s1">os</span>.<span class="pl-c1">walk</span>(<span class="pl-s1">root_dir</span>):
        <span class="pl-k">if</span> <span class="pl-s">'.git'</span> <span class="pl-c1">in</span> <span class="pl-s1">dirnames</span>:
            <span class="pl-s1">repo_path</span> <span class="pl-c1">=</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">abspath</span>(<span class="pl-s1">dirpath</span>)
            <span class="pl-s1">git_repos</span>.<span class="pl-c1">append</span>(<span class="pl-s1">repo_path</span>)
            <span class="pl-c"># è·³è¿‡å­ç›®å½•éå† (é¿å…å¤„ç†åµŒå¥—ä»“åº“)</span>
            <span class="pl-s1">dirnames</span>[:] <span class="pl-c1">=</span> []
    <span class="pl-k">return</span> <span class="pl-s1">git_repos</span>

<span class="pl-k">def</span> <span class="pl-en">check_and_unset_config</span>(<span class="pl-s1">repo_path</span>):
    <span class="pl-s">"""</span>
<span class="pl-s">    æ£€æŸ¥å¹¶å–æ¶ˆè®¾ç½®ç”¨æˆ·é…ç½®</span>
<span class="pl-s">    è¿”å›æ ¼å¼: (æ˜¯å¦å­˜åœ¨name, æ˜¯å¦å­˜åœ¨email, æ˜¯å¦æ‰§è¡Œäº†ä¿®æ”¹)</span>
<span class="pl-s">    """</span>
    <span class="pl-k">try</span>:
        <span class="pl-c"># æ£€æµ‹ user.name</span>
        <span class="pl-s1">name_check</span> <span class="pl-c1">=</span> <span class="pl-s1">subprocess</span>.<span class="pl-c1">run</span>(
            [<span class="pl-s">'git'</span>, <span class="pl-s">'-C'</span>, <span class="pl-s1">repo_path</span>, <span class="pl-s">'config'</span>, <span class="pl-s">'--local'</span>, <span class="pl-s">'--get'</span>, <span class="pl-s">'user.name'</span>],
            <span class="pl-s1">stdout</span><span class="pl-c1">=</span><span class="pl-s1">subprocess</span>.<span class="pl-c1">PIPE</span>,
            <span class="pl-s1">stderr</span><span class="pl-c1">=</span><span class="pl-s1">subprocess</span>.<span class="pl-c1">PIPE</span>,
            <span class="pl-s1">text</span><span class="pl-c1">=</span><span class="pl-c1">True</span>
        )
        <span class="pl-s1">has_name</span> <span class="pl-c1">=</span> <span class="pl-s1">name_check</span>.<span class="pl-c1">returncode</span> <span class="pl-c1">==</span> <span class="pl-c1">0</span>

        <span class="pl-c"># æ£€æµ‹ user.email</span>
        <span class="pl-s1">email_check</span> <span class="pl-c1">=</span> <span class="pl-s1">subprocess</span>.<span class="pl-c1">run</span>(
            [<span class="pl-s">'git'</span>, <span class="pl-s">'-C'</span>, <span class="pl-s1">repo_path</span>, <span class="pl-s">'config'</span>, <span class="pl-s">'--local'</span>, <span class="pl-s">'--get'</span>, <span class="pl-s">'user.email'</span>],
            <span class="pl-s1">stdout</span><span class="pl-c1">=</span><span class="pl-s1">subprocess</span>.<span class="pl-c1">PIPE</span>,
            <span class="pl-s1">stderr</span><span class="pl-c1">=</span><span class="pl-s1">subprocess</span>.<span class="pl-c1">PIPE</span>,
            <span class="pl-s1">text</span><span class="pl-c1">=</span><span class="pl-c1">True</span>
        )
        <span class="pl-s1">has_email</span> <span class="pl-c1">=</span> <span class="pl-s1">email_check</span>.<span class="pl-c1">returncode</span> <span class="pl-c1">==</span> <span class="pl-c1">0</span>

        <span class="pl-s1">modified</span> <span class="pl-c1">=</span> <span class="pl-c1">False</span>

        <span class="pl-c"># å–æ¶ˆè®¾ç½®é…ç½®</span>
        <span class="pl-k">if</span> <span class="pl-s1">has_name</span>:
            <span class="pl-s1">subprocess</span>.<span class="pl-c1">run</span>(
                [<span class="pl-s">'git'</span>, <span class="pl-s">'-C'</span>, <span class="pl-s1">repo_path</span>, <span class="pl-s">'config'</span>, <span class="pl-s">'--local'</span>, <span class="pl-s">'--unset'</span>, <span class="pl-s">'user.name'</span>],
                <span class="pl-s1">check</span><span class="pl-c1">=</span><span class="pl-c1">True</span>,
                <span class="pl-s1">stdout</span><span class="pl-c1">=</span><span class="pl-s1">subprocess</span>.<span class="pl-c1">DEVNULL</span>,
                <span class="pl-s1">stderr</span><span class="pl-c1">=</span><span class="pl-s1">subprocess</span>.<span class="pl-c1">DEVNULL</span>
            )
            <span class="pl-s1">modified</span> <span class="pl-c1">=</span> <span class="pl-c1">True</span>

        <span class="pl-k">if</span> <span class="pl-s1">has_email</span>:
            <span class="pl-s1">subprocess</span>.<span class="pl-c1">run</span>(
                [<span class="pl-s">'git'</span>, <span class="pl-s">'-C'</span>, <span class="pl-s1">repo_path</span>, <span class="pl-s">'config'</span>, <span class="pl-s">'--local'</span>, <span class="pl-s">'--unset'</span>, <span class="pl-s">'user.email'</span>],
                <span class="pl-s1">check</span><span class="pl-c1">=</span><span class="pl-c1">True</span>,
                <span class="pl-s1">stdout</span><span class="pl-c1">=</span><span class="pl-s1">subprocess</span>.<span class="pl-c1">DEVNULL</span>,
                <span class="pl-s1">stderr</span><span class="pl-c1">=</span><span class="pl-s1">subprocess</span>.<span class="pl-c1">DEVNULL</span>
            )
            <span class="pl-s1">modified</span> <span class="pl-c1">=</span> <span class="pl-c1">True</span>

        <span class="pl-k">return</span> <span class="pl-s1">has_name</span>, <span class="pl-s1">has_email</span>, <span class="pl-s1">modified</span>

    <span class="pl-k">except</span> <span class="pl-s1">subprocess</span>.<span class="pl-c1">CalledProcessError</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"å¤„ç†ä»“åº“æ—¶å‡ºé”™ <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">repo_path</span><span class="pl-kos">}</span></span>: <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-en">str</span>(<span class="pl-s1">e</span>)<span class="pl-kos">}</span></span>"</span>)
        <span class="pl-k">return</span> <span class="pl-c1">False</span>, <span class="pl-c1">False</span>, <span class="pl-c1">False</span>

<span class="pl-k">def</span> <span class="pl-en">main</span>():
    <span class="pl-s1">parser</span> <span class="pl-c1">=</span> <span class="pl-s1">argparse</span>.<span class="pl-c1">ArgumentParser</span>(<span class="pl-s1">description</span><span class="pl-c1">=</span><span class="pl-s">'Git ç”¨æˆ·ä¿¡æ¯æ¸…ç†å·¥å…·'</span>)
    <span class="pl-s1">parser</span>.<span class="pl-c1">add_argument</span>(
        <span class="pl-s">'directory'</span>,
        <span class="pl-s1">type</span><span class="pl-c1">=</span><span class="pl-s1">str</span>,
        <span class="pl-s1">help</span><span class="pl-c1">=</span><span class="pl-s">'è¦æ‰«æçš„æ ¹ç›®å½•è·¯å¾„'</span>,
        <span class="pl-s1">nargs</span><span class="pl-c1">=</span><span class="pl-s">'?'</span>,
        <span class="pl-s1">default</span><span class="pl-c1">=</span><span class="pl-s1">os</span>.<span class="pl-c1">getcwd</span>()
    )
    <span class="pl-s1">args</span> <span class="pl-c1">=</span> <span class="pl-s1">parser</span>.<span class="pl-c1">parse_args</span>()

    <span class="pl-s1">root_dir</span> <span class="pl-c1">=</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">abspath</span>(<span class="pl-s1">args</span>.<span class="pl-c1">directory</span>)
    <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">os</span>.<span class="pl-c1">path</span>.<span class="pl-c1">isdir</span>(<span class="pl-s1">root_dir</span>):
        <span class="pl-en">print</span>(<span class="pl-s">f"é”™è¯¯: è·¯å¾„ä¸å­˜åœ¨æˆ–ä¸æ˜¯ç›®å½• [<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">root_dir</span><span class="pl-kos">}</span></span>]"</span>)
        <span class="pl-s1">sys</span>.<span class="pl-c1">exit</span>(<span class="pl-c1">1</span>)

    <span class="pl-s1">repositories</span> <span class="pl-c1">=</span> <span class="pl-en">find_git_repos</span>(<span class="pl-s1">root_dir</span>)
    <span class="pl-en">print</span>(<span class="pl-s">f"å…±å‘ç° <span class="pl-s1"><span class="pl-kos">{</span><span class="pl-en">len</span>(<span class="pl-s1">repositories</span>)<span class="pl-kos">}</span></span> ä¸ª Git ä»“åº“"</span>)

    <span class="pl-k">for</span> <span class="pl-s1">repo</span> <span class="pl-c1">in</span> <span class="pl-s1">repositories</span>:
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-cce">\n</span>ğŸ” æ­£åœ¨æ£€æŸ¥ä»“åº“ï¼š<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">repo</span><span class="pl-kos">}</span></span>"</span>)
        <span class="pl-s1">has_name</span>, <span class="pl-s1">has_email</span>, <span class="pl-s1">modified</span> <span class="pl-c1">=</span> <span class="pl-en">check_and_unset_config</span>(<span class="pl-s1">repo</span>)

        <span class="pl-s1">status</span> <span class="pl-c1">=</span> []
        <span class="pl-k">if</span> <span class="pl-s1">has_name</span>: <span class="pl-s1">status</span>.<span class="pl-c1">append</span>(<span class="pl-s">"å­˜åœ¨ user.name"</span>)
        <span class="pl-k">if</span> <span class="pl-s1">has_email</span>: <span class="pl-s1">status</span>.<span class="pl-c1">append</span>(<span class="pl-s">"å­˜åœ¨ user.email"</span>)
      
        <span class="pl-k">if</span> <span class="pl-s1">status</span>:
            <span class="pl-en">print</span>(<span class="pl-s">"   â†’ å‘ç°é…ç½®: "</span> <span class="pl-c1">+</span> <span class="pl-s">", "</span>.<span class="pl-c1">join</span>(<span class="pl-s1">status</span>))
            <span class="pl-k">if</span> <span class="pl-s1">modified</span>:
                <span class="pl-en">print</span>(<span class="pl-s">"   âœ… å·²æ¸…ç†æœ¬åœ°é…ç½®"</span>)
        <span class="pl-k">else</span>:
            <span class="pl-en">print</span>(<span class="pl-s">"   âœ… æœªé…ç½®æœ¬åœ°ç”¨æˆ·ä¿¡æ¯"</span>)

<span class="pl-k">if</span> <span class="pl-s1">__name__</span> <span class="pl-c1">==</span> <span class="pl-s">"__main__"</span>:
    <span class="pl-en">main</span>()</pre></div>
<div class="markdown-heading"><h3 class="heading-element">ä½¿ç”¨æ–¹å¼</h3><a id="user-content-ä½¿ç”¨æ–¹å¼" class="anchor" aria-label="Permalink: ä½¿ç”¨æ–¹å¼" href="#ä½¿ç”¨æ–¹å¼"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="highlight highlight-source-shell"><pre><span class="pl-c"><span class="pl-c">#</span> æ‰«æå½“å‰ç›®å½•</span>
python git_cleaner.py

<span class="pl-c"><span class="pl-c">#</span> æ‰«ææŒ‡å®šç›®å½•</span>
python git_cleaner.py /path/to/projects</pre></div>
<p>è¾“å‡ºç¤ºä¾‹ï¼š</p>
<pre><code>å…±å‘ç° 3 ä¸ª Git ä»“åº“

ğŸ” æ­£åœ¨æ£€æŸ¥ä»“åº“ï¼š/home/user/projects/repo1
   â†’ å‘ç°é…ç½®: å­˜åœ¨ user.name, å­˜åœ¨ user.email
   âœ… å·²æ¸…ç†æœ¬åœ°é…ç½®

ğŸ” æ­£åœ¨æ£€æŸ¥ä»“åº“ï¼š/home/user/projects/repo2
   âœ… æœªé…ç½®æœ¬åœ°ç”¨æˆ·ä¿¡æ¯

ğŸ” æ­£åœ¨æ£€æŸ¥ä»“åº“ï¼š/home/user/projects/repo3
   â†’ å‘ç°é…ç½®: å­˜åœ¨ user.email
   âœ… å·²æ¸…ç†æœ¬åœ°é…ç½®
</code></pre>
