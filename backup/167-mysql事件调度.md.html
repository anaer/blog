
  <article class="markdown-body">
    <h2 id="event-scheduler">开启事件调度器（Event Scheduler）：</h2>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="k">SET</span><span class="w"> </span><span class="k">GLOBAL</span><span class="w"> </span><span class="n">event_scheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">;</span><span class="w">  </span>
</code></pre></div></div>
<p>这个命令会立即启用事件调度器，而不需要重启 MySQL 服务。你可以通过以下命令来验证事件调度器是否已经启用：  </p>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="k">SHOW</span><span class="w"> </span><span class="n">VARIABLES</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;event_scheduler&#39;</span><span class="p">;</span><span class="w">  </span>
</code></pre></div></div>
<p>如果结果是 <code>ON</code>，那么事件调度器已经成功启用。  </p>
<h3 id="_1">注意事项：</h3>
<ol>
<li><code>SET GLOBAL event_scheduler = ON;</code> 是一个全局变量的设置，通常需要管理员权限（<code>SUPER</code> 或 <code>SET</code> 权限）。  </li>
<li>如果你希望在 MySQL 启动时自动启用事件调度器，可以将配置文件中的 <code>event_scheduler</code> 设置为 <code>ON</code>：  </li>
</ol>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="k">[mysqld]</span><span class="w">  </span>
<span class="na">event_scheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">ON</span><span class="w">  </span>
</code></pre></div></div>
<p>这种方法需要重启 MySQL 服务来生效，但它确保每次启动时事件调度器都会启用。  </p>
<h3 id="_2">禁用事件调度器：</h3>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="k">SET</span><span class="w"> </span><span class="k">GLOBAL</span><span class="w"> </span><span class="n">event_scheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">;</span><span class="w">  </span>
</code></pre></div></div>
<h2 id="_3">定时删除日表</h2>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="c1">-- 打开事件调度器（需要管理员权限）  </span>
<span class="k">SET</span><span class="w"> </span><span class="k">GLOBAL</span><span class="w"> </span><span class="n">event_scheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">;</span><span class="w">  </span>

<span class="k">DELIMITER</span><span class="w"> </span><span class="err">$$</span><span class="w">  </span>

<span class="k">CREATE</span><span class="w"> </span><span class="n">EVENT</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">ev_drop_daily_table</span><span class="w">  </span>
<span class="k">ON</span><span class="w"> </span><span class="n">SCHEDULE</span><span class="w"> </span><span class="k">EVERY</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">DAY</span><span class="w">  </span>
<span class="c1">-- 从明天 02:10 开始第一次执行，之后每天同一时间执行  </span>
<span class="n">STARTS</span><span class="w"> </span><span class="p">(</span><span class="k">CURRENT_DATE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">DAY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">HOUR</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">MINUTE</span><span class="p">)</span><span class="w">  </span>
<span class="k">DO</span><span class="w">  </span>
<span class="k">BEGIN</span><span class="w">  </span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">tbl_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span><span class="w">  </span>

<span class="w">    </span><span class="c1">-- 生成要删除的表名（这里为昨天的表），例如 t_table_2025-11-20  </span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">tbl_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;t_table_&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">DATE_FORMAT</span><span class="p">(</span><span class="n">DATE_SUB</span><span class="p">(</span><span class="n">CURDATE</span><span class="p">(),</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">DAY</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;%Y-%m-%d&#39;</span><span class="p">));</span><span class="w">  </span>

<span class="w">    </span><span class="c1">-- 使用用户变量传入 PREPARE  </span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">sql_text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;DROP TABLE IF EXISTS `&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">tbl_name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;`&#39;</span><span class="p">);</span><span class="w">  </span>

<span class="w">    </span><span class="k">PREPARE</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">sql_text</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="k">EXECUTE</span><span class="w"> </span><span class="n">stmt</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="k">DEALLOCATE</span><span class="w"> </span><span class="k">PREPARE</span><span class="w"> </span><span class="n">stmt</span><span class="p">;</span><span class="w">  </span>
<span class="k">END</span><span class="err">$$</span><span class="w">  </span>

<span class="k">DELIMITER</span><span class="w"> </span><span class="p">;</span><span class="w">  </span>
</code></pre></div></div>
<p>查询事件执行情况:  </p>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">EVENT_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">LAST_EXECUTED</span><span class="w">  </span>
<span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">events</span><span class="w">  </span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">EVENT_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ev_drop_daily_table&#39;</span><span class="p">;</span><span class="w">  </span>
</code></pre></div></div>
<p>定时删除历史数据:  </p>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="n">EVENT</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="o">`</span><span class="n">ev_delete_history</span><span class="o">`</span><span class="w">   </span>
<span class="k">ON</span><span class="w"> </span><span class="n">SCHEDULE</span><span class="w"> </span><span class="k">EVERY</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">DAY</span><span class="w">   </span>
<span class="n">STARTS</span><span class="w"> </span><span class="p">(</span><span class="k">CURRENT_DATE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">DAY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">HOUR</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">MINUTE</span><span class="p">)</span><span class="w">    </span>
<span class="k">DO</span><span class="w">   </span>
<span class="k">BEGIN</span><span class="w">    </span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">sql_text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;DELETE FROM t_history WHERE create_time &lt; DATE_SUB(now(),INTERVAL 100 DAY);&#39;</span><span class="p">;</span><span class="w">    </span>

<span class="w">    </span><span class="k">PREPARE</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">sql_text</span><span class="p">;</span><span class="w">    </span>
<span class="w">    </span><span class="k">EXECUTE</span><span class="w"> </span><span class="n">stmt</span><span class="p">;</span><span class="w">    </span>
<span class="w">    </span><span class="k">DEALLOCATE</span><span class="w"> </span><span class="k">PREPARE</span><span class="w"> </span><span class="n">stmt</span><span class="p">;</span><span class="w">    </span>
<span class="k">END</span><span class="w">  </span>
</code></pre></div></div>
  </article>
  
<script>
document.addEventListener('DOMContentLoaded', () => {
  // 复制功能
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const code = btn.nextElementSibling.querySelector('code').innerText;
      navigator.clipboard.writeText(code).then(() => {
        btn.textContent = '已复制';
        setTimeout(() => btn.textContent = '复制', 1500);
      });
    });
  });

  // 折叠功能
  document.addEventListener('click', e => {
    if (e.target.classList.contains('fold-btn')) {
      const pre = e.target.parentElement.querySelector('pre');
      const collapsed = pre.style.display === 'none';
      pre.style.display = collapsed ? 'block' : 'none';
      e.target.textContent = collapsed ? '收起' : '展开';
    }
  });
});
</script>

