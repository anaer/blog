
  <article class="markdown-body">
    <h1 id="spring-boot">Spring Boot 配置</h1>
<p>仅列举相关配置, 具体配置时, 还需要根据实际使用的版本环境进行调整.</p>
<h3 id="tomcat">Tomcat连接池</h3>
<p>默认配置:
org\springframework\boot\spring-boot-autoconfigure\2.3.12.RELEASE\spring-boot-autoconfigure-2.3.12.RELEASE.jar\META-INF\spring-configuration-metadata.json</p>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="nt">server</span><span class="p">:</span>
<span class="w">  </span><span class="nt">tomcat</span><span class="p">:</span>
<span class="w">    </span><span class="nt">max-connections</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span><span class="w">  </span><span class="c1"># 最大连接数 默认:8192</span>
<span class="w">    </span><span class="nt">threads</span><span class="p">:</span>
<span class="w">      </span><span class="nt">max</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">800</span><span class="w">              </span><span class="c1"># 最大工作线程数 默认:200</span>
<span class="w">      </span><span class="nt">min-spare</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span><span class="w">        </span><span class="c1"># 最小空闲线程数 默认:10</span>
<span class="w">    </span><span class="nt">accept-count</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span><span class="w">       </span><span class="c1"># 等待队列长度 默认:100</span>
<span class="w">    </span><span class="nt">connection-timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20000</span><span class="w"> </span><span class="c1"># 默认未配置</span>
</code></pre></div></div>

<h3 id="_1">数据库连接池</h3>
<p>SpringBoot默认使用HikariCP作为数据库连接池</p>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="nt">spring</span><span class="p">:</span>
<span class="w">  </span><span class="nt">datasource</span><span class="p">:</span>
<span class="w">    </span><span class="nt">hikari</span><span class="p">:</span>
<span class="w">      </span><span class="nt">maximum-pool-size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span><span class="w">               </span><span class="c1"># 最大连接数，默认:10</span>
<span class="w">      </span><span class="nt">minimum-idle</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w">                         </span><span class="c1"># 最小空闲连接，默认:10</span>
<span class="w">      </span><span class="nt">connection-timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30000</span>
<span class="w">      </span><span class="nt">idle-timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">600000</span><span class="w">                   </span><span class="c1"># 空闲连接超时时间，默认:600000（10分钟）</span>
<span class="w">      </span><span class="nt">max-lifetime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1800000</span><span class="w">                 </span><span class="c1"># 连接最大存活时间 默认:1800000（30分钟）</span>
<span class="w">      </span><span class="nt">leak-detection-threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60000</span><span class="w"> </span><span class="c1"># 连接泄露检查阈值，默认:0（关闭）</span>
</code></pre></div></div>

<h3 id="jackson">Jackson时区序列化</h3>
<p>SpringBoot默认使用Jackson处理JSON序列化，Jackson会使用系统时区，这在分布式部署时会导致不一致的问题。</p>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="nt">spring</span><span class="p">:</span>
<span class="w">  </span><span class="nt">jackson</span><span class="p">:</span>
<span class="w">    </span><span class="nt">time-zone</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GMT+8</span>
<span class="w">    </span><span class="nt">date-format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yyyy-MM-dd HH:mm:ss</span>
<span class="w">    </span><span class="nt">serialization</span><span class="p">:</span>
<span class="w">      </span><span class="nt">write-dates-as-timestamps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div></div>

<h3 id="_2">日志配置</h3>
<p>SpringBoot默认使用Logback，但默认配置下没有对日志文件进行滚动和清理。</p>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="nt">logging</span><span class="p">:</span>
<span class="w">  </span><span class="nt">file</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app.log</span>
<span class="w">  </span><span class="nt">logback</span><span class="p">:</span>
<span class="w">    </span><span class="nt">rollingpolicy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">max-file-size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100MB</span>
<span class="w">      </span><span class="nt">max-history</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<span class="w">      </span><span class="nt">total-size-cap</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3GB</span>
</code></pre></div></div>

<h3 id="_3">缓存配置</h3>
<p>SpringBoot的Cacheable注解默认使用ConcurrentHashMap作为缓存实现，但这个实现没有过期机制，也没有大小限制。在高并发场景下，缓存会无限增长，最终导致内存溢出。
可以考虑使用Caffeine替代默认实现，可以提供更好的性能和内存管理能力。</p>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="nt">spring</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cache</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">caffeine</span>
<span class="w">    </span><span class="nt">caffeine</span><span class="p">:</span>
<span class="w">      </span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">maximumSize=10000,expireAfterWrite=600s</span>
</code></pre></div></div>

<h3 id="_4">监控端点</h3>
<p>SpringBoot Actuator默认暴露了很多监控端点，包括健康检查、配置信息、环境变量等。</p>
<p>只暴露必要的端点，并且配置适当的安全策略，避免信息泄漏。</p>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="nt">management</span><span class="p">:</span>
<span class="w">  </span><span class="nt">endpoints</span><span class="p">:</span>
<span class="w">    </span><span class="nt">web</span><span class="p">:</span>
<span class="w">      </span><span class="nt">exposure</span><span class="p">:</span>
<span class="w">        </span><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">health,info,metrics</span>
<span class="w">  </span><span class="nt">endpoint</span><span class="p">:</span>
<span class="w">    </span><span class="nt">health</span><span class="p">:</span>
<span class="w">      </span><span class="nt">show-details</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">when-authorized</span>
</code></pre></div></div>

<h3 id="_5">文件上传大小限制</h3>
<p>SpringBoot默认的文件上传限制非常小，单个文件只能上传1MB，整个请求大小限制10MB。</p>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="nt">spring</span><span class="p">:</span>
<span class="w">  </span><span class="nt">servlet</span><span class="p">:</span>
<span class="w">    </span><span class="nt">multipart</span><span class="p">:</span>
<span class="w">      </span><span class="nt">max-file-size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100MB</span>
<span class="w">      </span><span class="nt">max-request-size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100MB</span>
<span class="w">      </span><span class="nt">file-size-threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2KB</span>
<span class="w">      </span><span class="nt">location</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp</span>
<span class="w">      </span><span class="nt">resolve-lazily</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div></div>

<h3 id="_6">异步线程池配置</h3>
<p>使用<code>@Async</code>注解时，SpringBoot默认使用<code>SimpleAsyncTaskExecutor</code>，这个执行器每次都会创建新线程，没有线程池复用机制。高并发情况下会创建大量线程，最终导致系统资源耗尽。</p>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="nt">spring</span><span class="p">:</span>
<span class="w">  </span><span class="nt">task</span><span class="p">:</span>
<span class="w">    </span><span class="nt">execution</span><span class="p">:</span>
<span class="w">      </span><span class="nt">pool</span><span class="p">:</span>
<span class="w">        </span><span class="nt">core-size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
<span class="w">        </span><span class="nt">max-size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">16</span>
<span class="w">        </span><span class="nt">queue-capacity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="w">        </span><span class="nt">keep-alive</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60s</span>
<span class="w">      </span><span class="nt">thread-name-prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">async-task-</span>
<span class="w">    </span><span class="nt">scheduling</span><span class="p">:</span>
<span class="w">      </span><span class="nt">pool</span><span class="p">:</span>
<span class="w">        </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="w">      </span><span class="nt">thread-name-prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">scheduling-</span>
</code></pre></div></div>

<h3 id="_7">静态资源缓存策略</h3>
<p>SpringBoot默认不为静态资源设置HTTP缓存头，浏览器每次都会重新请求CSS、JS、图片等静态文件，影响页面加载性能。</p>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="nt">spring</span><span class="p">:</span>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">      </span><span class="nt">cache</span><span class="p">:</span>
<span class="w">        </span><span class="nt">cachecontrol</span><span class="p">:</span>
<span class="w">          </span><span class="nt">max-age</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">365d</span>
<span class="w">          </span><span class="nt">cache-public</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">chain</span><span class="p">:</span>
<span class="w">        </span><span class="nt">strategy</span><span class="p">:</span>
<span class="w">          </span><span class="nt">content</span><span class="p">:</span>
<span class="w">            </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">            </span><span class="nt">paths</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/**</span>
<span class="w">        </span><span class="nt">cache</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">static-locations</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classpath:/static/</span>
</code></pre></div></div>

<p>开启内容版本化策略后，SpringBoot会根据文件内容生成MD5哈希值作为版本号，文件名变成<code>style-abc123.css</code>这样的格式。当文件内容发生变化时，哈希值也会变化，浏览器会认为这是新文件重新下载；如果文件没变化，浏览器就直接使用缓存，有效提升页面加载速度。</p>
<h3 id="_8">数据库事务超时</h3>
<p><code>@Transactional</code>注解默认没有设置超时时间，长时间运行的事务会一直持有数据库锁，影响其他操作的执行。</p>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="nd">@Transactional</span><span class="p">(</span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="n">rollbackFor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Exception</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">batchProcess</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dataList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 分批处理，避免长事务</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">batchSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dataList</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">batchSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataList</span><span class="p">.</span><span class="na">subList</span><span class="p">(</span><span class="n">i</span><span class="p">,</span>
<span class="w">            </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">batchSize</span><span class="p">,</span><span class="w"> </span><span class="n">dataList</span><span class="p">.</span><span class="na">size</span><span class="p">()));</span>
<span class="w">        </span><span class="n">processBatch</span><span class="p">(</span><span class="n">batch</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
  </article>
  
<script>
document.addEventListener('DOMContentLoaded', () => {
  // 复制功能
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const code = btn.nextElementSibling.querySelector('code').innerText;
      navigator.clipboard.writeText(code).then(() => {
        btn.textContent = '已复制';
        setTimeout(() => btn.textContent = '复制', 1500);
      });
    });
  });

  // 折叠功能
  document.addEventListener('click', e => {
    if (e.target.classList.contains('fold-btn')) {
      const pre = e.target.parentElement.querySelector('pre');
      const collapsed = pre.style.display === 'none';
      pre.style.display = collapsed ? 'block' : 'none';
      e.target.textContent = collapsed ? '收起' : '展开';
    }
  });
});
</script>

