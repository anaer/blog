
  <article class="markdown-body">
    <h2 id="_1">安装</h2>
<p>系统: Ubuntu 20.04.6 LTS  </p>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code>apt-get<span class="w"> </span>install<span class="w"> </span>fail2ban<span class="w">  </span>
</code></pre></div></div>
<h2 id="_2">命令</h2>
<h3 id="_3">查询服务状态</h3>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code>service<span class="w"> </span>fail2ban<span class="w"> </span>status<span class="w">  </span>
systemctl<span class="w"> </span>status<span class="w"> </span>fail2ban.service<span class="w">  </span>
</code></pre></div></div>
<h3 id="_4">查询状态</h3>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="c1"># 查看启用的规则  </span>
<span class="c1"># fail2ban-client status  </span>
Status<span class="w">  </span>
<span class="p">|</span>-<span class="w"> </span>Number<span class="w"> </span>of<span class="w"> </span>jail:<span class="w">      </span><span class="m">1</span><span class="w">  </span>
<span class="sb">`</span>-<span class="w"> </span>Jail<span class="w"> </span>list:<span class="w">   </span>sshd<span class="w">  </span>

<span class="c1"># 查看规则详情  </span>
<span class="c1"># fail2ban-client status sshd  </span>
Status<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>jail:<span class="w"> </span>sshd<span class="w">  </span>
<span class="p">|</span>-<span class="w"> </span>Filter<span class="w">  </span>
<span class="p">|</span><span class="w">  </span><span class="p">|</span>-<span class="w"> </span>Currently<span class="w"> </span>failed:<span class="w"> </span><span class="m">0</span><span class="w">  </span>
<span class="p">|</span><span class="w">  </span><span class="p">|</span>-<span class="w"> </span>Total<span class="w"> </span>failed:<span class="w">     </span><span class="m">0</span><span class="w">  </span>
<span class="p">|</span><span class="w">  </span><span class="sb">`</span>-<span class="w"> </span>File<span class="w"> </span>list:<span class="w">        </span>/var/log/auth.log<span class="w">  </span>
<span class="sb">`</span>-<span class="w"> </span>Actions<span class="w">  </span>
<span class="w">   </span><span class="p">|</span>-<span class="w"> </span>Currently<span class="w"> </span>banned:<span class="w"> </span><span class="m">0</span><span class="w">  </span>
<span class="w">   </span><span class="p">|</span>-<span class="w"> </span>Total<span class="w"> </span>banned:<span class="w">     </span><span class="m">0</span><span class="w">  </span>
<span class="w">   </span><span class="sb">`</span>-<span class="w"> </span>Banned<span class="w"> </span>IP<span class="w"> </span>list:<span class="w">  </span>

<span class="c1"># 重新加载配置  </span>
<span class="c1"># fail2ban-client reload  </span>

<span class="c1"># 重新加载单个配置  </span>
<span class="c1"># fail2ban-client reload sshd  </span>

<span class="c1"># 手动解禁IP  </span>
<span class="c1"># fail2ban-client set sshd unbanip 192.168.1.1  </span>
</code></pre></div></div>
<h2 id="_5">配置</h2>
<p>配置目录: <code>/etc/fail2ban</code>  </p>
<p>修改sshd配置<br />
/etc/fail2ban/jail.d/sshd.conf  </p>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="o">[</span>sshd<span class="o">]</span><span class="w">  </span>
<span class="nv">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="w">  </span>
<span class="nv">mode</span><span class="w">   </span><span class="o">=</span><span class="w"> </span>normal<span class="w">  </span>
<span class="nv">port</span><span class="w">    </span><span class="o">=</span><span class="w"> </span>ssh<span class="w">  </span>
<span class="nv">filter</span><span class="w">  </span><span class="o">=</span><span class="w"> </span>sshd<span class="w">  </span>
<span class="nv">banaction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>iptables<span class="w">  </span>
<span class="w">            </span>bark<span class="o">[</span><span class="nv">name</span><span class="o">=</span>sshd<span class="o">]</span><span class="w">  </span>
<span class="nv">backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>systemd<span class="w">  </span>
<span class="nv">maxretry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="w">  </span>
<span class="nv">findtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>1d<span class="w">  </span>
<span class="nv">bantime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>2w<span class="w">  </span>
<span class="nv">ignoreip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">127</span>.0.0.1/8<span class="w">  </span>
<span class="nv">logpath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>%<span class="o">(</span>sshd_log<span class="o">)</span>s<span class="w">  </span>
<span class="c1">#backend = %(sshd_backend)s  </span>
</code></pre></div></div>
<p>添加bark.conf自定义action<br />
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code>vim<span class="w"> </span>/etc/fail2ban/action.d/bark.conf<span class="w">  </span>
</code></pre></div></div></p>
<div class="highlight"><div><button class="fold-btn">收起</button><button class="copy-btn">复制</button>
<pre><span></span><code><span class="o">[</span>Definition<span class="o">]</span><span class="w">  </span>
<span class="nv">norestored</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w">  </span>
<span class="nv">actionban</span><span class="w">   </span><span class="o">=</span><span class="w"> </span>/usr/bin/python3<span class="w"> </span>/root/script/bark.py<span class="w"> </span>fail2ban-&lt;name&gt;<span class="w"> </span>&lt;ip&gt;<span class="w">  </span>
<span class="nv">actionunban</span><span class="w"> </span><span class="o">=</span><span class="w">  </span>
<span class="nv">actioncheck</span><span class="w"> </span><span class="o">=</span><span class="w">  </span>
<span class="nv">actionstart</span><span class="w"> </span><span class="o">=</span><span class="w">  </span>
<span class="nv">actionstop</span><span class="w"> </span><span class="o">=</span><span class="w">  </span>

<span class="o">[</span>Init<span class="o">]</span><span class="w">  </span>

<span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>default<span class="w">  </span>
<span class="nv">blocktype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>unreachable<span class="w">  </span>
</code></pre></div></div>
<h2 id="_6">参考链接</h2>
<p><a href="https://github.com/wangdoc/ssh-tutorial/blob/main/docs/fail2ban.md">Fail2Ban 教程</a><br />
<a href="https://idcflare.com/t/topic/17588">Fail2ban推荐配置脚本</a>  </p>
  </article>
  
<script>
document.addEventListener('DOMContentLoaded', () => {
  // 复制功能
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const code = btn.nextElementSibling.querySelector('code').innerText;
      navigator.clipboard.writeText(code).then(() => {
        btn.textContent = '已复制';
        setTimeout(() => btn.textContent = '复制', 1500);
      });
    });
  });

  // 折叠功能
  document.addEventListener('click', e => {
    if (e.target.classList.contains('fold-btn')) {
      const pre = e.target.parentElement.querySelector('pre');
      const collapsed = pre.style.display === 'none';
      pre.style.display = collapsed ? 'block' : 'none';
      e.target.textContent = collapsed ? '收起' : '展开';
    }
  });
});
</script>

