<div class="markdown-heading"><h2 class="heading-element">安装</h2><a id="user-content-安装" class="anchor" aria-label="Permalink: 安装" href="#安装"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>系统: Ubuntu 20.04.6 LTS</p>
<div class="highlight highlight-source-shell"><pre>apt-get install fail2ban</pre></div>
<div class="markdown-heading"><h2 class="heading-element">命令</h2><a id="user-content-命令" class="anchor" aria-label="Permalink: 命令" href="#命令"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="markdown-heading"><h3 class="heading-element">查询服务状态</h3><a id="user-content-查询服务状态" class="anchor" aria-label="Permalink: 查询服务状态" href="#查询服务状态"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="highlight highlight-source-shell"><pre>service fail2ban status
systemctl status fail2ban.service</pre></div>
<div class="markdown-heading"><h3 class="heading-element">查询状态</h3><a id="user-content-查询状态" class="anchor" aria-label="Permalink: 查询状态" href="#查询状态"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="highlight highlight-source-shell"><pre><span class="pl-c"><span class="pl-c">#</span> 查看启用的规则</span>
<span class="pl-c"><span class="pl-c">#</span> fail2ban-client status</span>
Status
<span class="pl-k">|</span>- Number of jail:      1
<span class="pl-s"><span class="pl-pds">`</span>- Jail list:   sshd</span>
<span class="pl-s"></span>
<span class="pl-s"><span class="pl-c"><span class="pl-c">#</span> 查看规则详情</span></span>
<span class="pl-s"><span class="pl-c"><span class="pl-c">#</span> fail2ban-client status sshd</span></span>
<span class="pl-s">Status <span class="pl-k">for</span> the jail: sshd</span>
<span class="pl-s"><span class="pl-k">|</span>- Filter</span>
<span class="pl-s"><span class="pl-k">|</span>  <span class="pl-k">|</span>- Currently failed: 0</span>
<span class="pl-s"><span class="pl-k">|</span>  <span class="pl-k">|</span>- Total failed:     0</span>
<span class="pl-s"><span class="pl-k">|</span>  <span class="pl-pds">`</span></span>- File list:        /var/log/auth.log
<span class="pl-s"><span class="pl-pds">`</span>- Actions</span>
<span class="pl-s">   <span class="pl-k">|</span>- Currently banned: 0</span>
<span class="pl-s">   <span class="pl-k">|</span>- Total banned:     0</span>
<span class="pl-s">   <span class="pl-pds">`</span></span>- Banned IP list:

<span class="pl-c"><span class="pl-c">#</span> 重新加载配置</span>
<span class="pl-c"><span class="pl-c">#</span> fail2ban-client reload</span>

<span class="pl-c"><span class="pl-c">#</span> 重新加载单个配置</span>
<span class="pl-c"><span class="pl-c">#</span> fail2ban-client reload sshd</span>

<span class="pl-c"><span class="pl-c">#</span> 手动解禁IP</span>
<span class="pl-c"><span class="pl-c">#</span> fail2ban-client set sshd unbanip 192.168.1.1</span></pre></div>
<div class="markdown-heading"><h2 class="heading-element">配置</h2><a id="user-content-配置" class="anchor" aria-label="Permalink: 配置" href="#配置"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>配置目录: <code>/etc/fail2ban</code></p>
<p>修改sshd配置
/etc/fail2ban/jail.d/sshd.conf</p>
<div class="highlight highlight-source-shell"><pre>[sshd]
enabled = <span class="pl-c1">true</span>
mode   = normal
port    = ssh
filter  = sshd
banaction = iptables
            bark[name<span class="pl-k">=</span>sshd]
backend = systemd
maxretry = 2
findtime = 1d
bantime = 2w
ignoreip = 127.0.0.1/8
logpath = %(sshd_log)s
<span class="pl-c"><span class="pl-c">#</span>backend = %(sshd_backend)s</span></pre></div>
<p>添加bark.conf自定义action</p>
<div class="highlight highlight-source-shell"><pre>vim /etc/fail2ban/action.d/bark.conf</pre></div>
<div class="highlight highlight-source-shell"><pre>[Definition]
norestored = 1
actionban   = /usr/bin/python3 /root/script/bark.py fail2ban-<span class="pl-k">&lt;</span>name<span class="pl-k">&gt;</span> <span class="pl-k">&lt;</span>ip<span class="pl-k">&gt;</span>
actionunban =
actioncheck =
actionstart =
actionstop =

[Init]

name = default
blocktype = unreachable</pre></div>
<div class="markdown-heading"><h2 class="heading-element">参考链接</h2><a id="user-content-参考链接" class="anchor" aria-label="Permalink: 参考链接" href="#参考链接"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p><a href="https://github.com/wangdoc/ssh-tutorial/blob/main/docs/fail2ban.md">Fail2Ban 教程</a></p>
